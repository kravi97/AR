<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Business Card - Image Tracking</title>
    
    <!-- AR.js with A-Frame for Image Tracking -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #arjs-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        #arjs-loader .loader {
            border: 8px solid rgba(255,255,255,0.3);
            border-top: 8px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #arjs-loader h1 {
            font-size: 24px;
            margin: 10px 0;
        }
        
        #arjs-loader p {
            font-size: 16px;
            opacity: 0.8;
            text-align: center;
            padding: 0 20px;
        }
        
        .ar-instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
            max-width: 90%;
            backdrop-filter: blur(10px);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .ar-instructions.found {
            background: rgba(40, 167, 69, 0.9);
            animation: none;
        }
        
        .ar-instructions h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
        }
        
        .ar-instructions p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .back-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        .qr-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            max-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .qr-info img {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .qr-info p {
            margin: 0;
            font-size: 12px;
            color: #333;
            text-align: center;
        }
        
        @media (max-width: 600px) {
            .qr-info {
                max-width: 120px;
                padding: 10px;
            }
            
            .ar-instructions h3 {
                font-size: 16px;
            }
            
            .ar-instructions p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="arjs-loader">
        <div class="loader"></div>
        <h1>Loading AR Experience...</h1>
        <p>Point your camera at the business card or QR code</p>
    </div>
    
    <!-- AR Instructions -->
    <div class="ar-instructions" id="instructions">
        <h3>üì± Point Camera at Business Card</h3>
        <p>Scanning for target image...</p>
    </div>
    
    <!-- Back Button -->
    <a href="index.html" class="back-button">‚Üê Back to Card</a>
    
    <!-- Help Button -->
    <a href="create-target.html" class="back-button" style="right: auto; left: 20px; background: linear-gradient(45deg, #28a745, #20c997);">
        ‚ùì Setup Help
    </a>
    
    <!-- QR Code Info -->
    <div class="qr-info">
        <img src="./assets/QR Images/qrcode_samir_calm-panda-2bd6b0.netlify.app.png" alt="QR Code">
        <p><strong>Scan this QR</strong><br>to share</p>
    </div>
    
    <!-- A-Frame AR Scene with MindAR Image Tracking -->
    <a-scene
        mindar-image="imageTargetSrc: ./assets/targets.mind; filterMinCF:0.0001; filterBeta: 0.01; warmupTolerance: 5; missTolerance: 5"
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        onload="handleSceneLoad()">
        
        <a-assets>
            <video id="ar-video-samir" src="./assets/SameerR.webm" preload="auto" loop="true" muted crossorigin="anonymous" playsinline webkit-playsinline autoplay="false"></video>
            <video id="ar-video-kaushik" src="./assets/KaushikG.webm" preload="auto" loop="true" muted crossorigin="anonymous" playsinline webkit-playsinline autoplay="false"></video>
        </a-assets>
        
        <!-- Camera -->
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <!-- Target Entity - Triggers when business card is detected -->
        <a-entity mindar-image-target="targetIndex: 0">
            
            <!-- Video Display - Appears above the card (will be set dynamically) -->
            <a-video 
                id="main-video-display"
                src="#ar-video-samir"
                width="1.5"
                height="2"
                position="0 0 0.1"
                play-on-track="videoId: ar-video-samir">
            </a-video>
            
            <!-- Badge 1 - ABP (Top) -->
            <a-plane
                class="badge"
                position="0 1.3 0.2"
                width="1.2"
                height="0.7"
                color="#ffffff"
                opacity="0.95"
                animation="property: position; to: 0 1.5 0.2; dur: 1500; easing: easeInOutQuad; loop: true; dir: alternate"
                visible="false">
                <a-text 
                    value="Enterprise .NET & ABP"
                    align="center"
                    width="2.2"
                    color="#2c3e50"
                    position="0 0.15 0.01"></a-text>
                <a-text 
                    value="robust enterprise solutions"
                    align="center"
                    width="2"
                    color="#7f8c8d"
                    position="0 -0.1 0.01"></a-text>
            </a-plane>
            
            <!-- Badge 2 - D2C (Top Left) -->
            <a-plane
                class="badge"
                position="-1 0.8 0.15"
                width="1.2"
                height="0.7"
                color="#ffffff"
                opacity="0.95"
                animation="property: position; to: -1.1 0.8 0.15; dur: 1800; easing: easeInOutQuad; loop: true; dir: alternate"
                visible="false">
                <a-text 
                    value="AI Design to Code"
                    align="center"
                    width="2.2"
                    color="#2c3e50"
                    position="0 0.15 0.01"></a-text>
                <a-text 
                    value="transforming designs"
                    align="center"
                    width="2"
                    color="#7f8c8d"
                    position="0 -0.1 0.01"></a-text>
            </a-plane>
            
            <!-- Badge 3 - DS (Bottom Left) -->
            <a-plane
                class="badge"
                position="-1 -0.8 0.15"
                width="1.2"
                height="0.7"
                color="#ffffff"
                opacity="0.95"
                animation="property: position; to: -1.1 -0.8 0.15; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate"
                visible="false">
                <a-text 
                    value="Adaptive Design System"
                    align="center"
                    width="2.2"
                    color="#2c3e50"
                    position="0 0.15 0.01"></a-text>
                <a-text 
                    value="scalable solutions"
                    align="center"
                    width="2"
                    color="#7f8c8d"
                    position="0 -0.1 0.01"></a-text>
            </a-plane>
            
            <!-- Badge 4 - DTW (Top Right) -->
            <a-plane
                class="badge"
                position="1 0.8 0.15"
                width="1.2"
                height="0.7"
                color="#ffffff"
                opacity="0.95"
                animation="property: position; to: 1.1 0.8 0.15; dur: 1700; easing: easeInOutQuad; loop: true; dir: alternate"
                visible="false">
                <a-text 
                    value="Design Workshops"
                    align="center"
                    width="2.2"
                    color="#2c3e50"
                    position="0 0.15 0.01"></a-text>
                <a-text 
                    value="innovate collaboratively"
                    align="center"
                    width="2"
                    color="#7f8c8d"
                    position="0 -0.1 0.01"></a-text>
            </a-plane>
            
            <!-- Badge 5 - Spec Driven (Bottom Right) -->
            <a-plane
                class="badge"
                position="1 -0.8 0.15"
                width="1.2"
                height="0.7"
                color="#ffffff"
                opacity="0.95"
                animation="property: position; to: 1.1 -0.8 0.15; dur: 1900; easing: easeInOutQuad; loop: true; dir: alternate"
                visible="false">
                <a-text 
                    value="Spec Driven with AI"
                    align="center"
                    width="2.2"
                    color="#2c3e50"
                    position="0 0.15 0.01"></a-text>
                <a-text 
                    value="precise development"
                    align="center"
                    width="2"
                    color="#7f8c8d"
                    position="0 -0.1 0.01"></a-text>
            </a-plane>
            
        </a-entity>
    </a-scene>
    
    <script>
        // Check URL parameter for which video/mind file to use
        const urlParams = new URLSearchParams(window.location.search);
        const person = urlParams.get('person') || 'samir'; // Default to samir
        
        // Set MindAR target source based on person parameter
        const mindFile = person === 'kaushik' ? './assets/Kaushik.mind' : './assets/samir.mind';
        console.log('üéØ Loading mind file:', mindFile, 'for person:', person);
        
        // Update the a-scene mindar-image attribute before scene initialization
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.setAttribute('mindar-image', {
                    imageTargetSrc: mindFile,
                    filterMinCF: 0.0001,
                    filterBeta: 0.01,
                    warmupTolerance: 5,
                    missTolerance: 5
                });
                console.log('‚úÖ MindAR initialized with:', mindFile);
            }
        });
        
        // Set video source based on URL parameter
        window.addEventListener('load', function() {
            const videoDisplay = document.querySelector('#main-video-display');
            const videoId = person === 'kaushik' ? 'ar-video-kaushik' : 'ar-video-samir';
            
            if (videoDisplay) {
                videoDisplay.setAttribute('src', '#' + videoId);
                videoDisplay.setAttribute('play-on-track', 'videoId: ' + videoId);
                console.log('üìπ Video set to:', videoId);
            }
        });
        
        // Handle scene load errors
        function handleSceneLoad() {
            console.log('Scene loading...');
        }
        
        // Custom component to play video on track
        AFRAME.registerComponent('play-on-track', {
            schema: {
                videoId: { type: 'string', default: 'ar-video-samir' }
            },
            init: function() {
                const videoId = this.data.videoId;
                const videoEl = document.querySelector('#' + videoId);
                let isFirstScan = true;
                let userInteracted = false;
                
                console.log('üé¨ Initializing video component with:', videoId);
                
                // Ensure video starts muted
                if (videoEl) {
                    videoEl.muted = true;
                    videoEl.volume = 0;
                }
                
                // Enable audio on any user interaction
                const enableAudio = () => {
                    userInteracted = true;
                    console.log('‚úÖ User interaction detected - audio enabled');
                };
                
                document.addEventListener('touchstart', enableAudio, { once: true });
                document.addEventListener('click', enableAudio, { once: true });
                
                this.el.sceneEl.addEventListener('targetFound', () => {
                    console.log('‚úÖ Business card detected! First scan:', isFirstScan, 'User interacted:', userInteracted);
                    if (videoEl) {
                        // Reset video
                        videoEl.pause();
                        videoEl.currentTime = 0;
                        
                        if (isFirstScan) {
                            // First scan - play muted
                            videoEl.muted = true;
                            videoEl.volume = 0;
                            console.log('üîá First scan - playing MUTED');
                            
                            videoEl.play()
                                .then(() => console.log('‚úÖ Video playing muted'))
                                .catch(e => console.log('Video play error:', e));
                        } else {
                            // Second scan onwards - try with sound
                            videoEl.muted = false;
                            videoEl.volume = 1.0;
                            console.log('üîä Second+ scan - attempting WITH SOUND');
                            
                            videoEl.play()
                                .then(() => {
                                    console.log('‚úÖ Video playing with sound!');
                                })
                                .catch(e => {
                                    console.log('‚ö†Ô∏è Autoplay with sound blocked, playing muted:', e);
                                    // If blocked, play muted and wait for user interaction
                                    videoEl.muted = true;
                                    videoEl.play().then(() => {
                                        // Wait for user interaction to unmute
                                        const unmute = () => {
                                            videoEl.muted = false;
                                            videoEl.volume = 1.0;
                                            console.log('üîä Unmuted after user interaction');
                                        };
                                        document.addEventListener('touchstart', unmute, { once: true });
                                        document.addEventListener('click', unmute, { once: true });
                                    });
                                });
                        }
                    }
                });
                
                this.el.sceneEl.addEventListener('targetLost', () => {
                    console.log('‚ùå Business card lost');
                    if (videoEl && !videoEl.paused) {
                        videoEl.pause();
                        videoEl.currentTime = 0;
                        isFirstScan = false; // Next scan will attempt sound
                        console.log('Setting isFirstScan to false');
                    }
                });
            }
        });
        
        // Hide loading screen when AR is ready
        window.addEventListener('load', function () {
            const loader = document.getElementById('arjs-loader');
            const instructions = document.getElementById('instructions');
            
            setTimeout(() => {
                loader.style.display = 'none';
            }, 3000);
            
            // Listen for AR target detection
            const sceneEl = document.querySelector('a-scene');
            
            sceneEl.addEventListener('arReady', () => {
                console.log('üéØ AR System Ready');
            });
            
            sceneEl.addEventListener('arError', (err) => {
                console.error('‚ùå AR Error:', err);
                instructions.querySelector('h3').textContent = '‚ö†Ô∏è AR Setup Required';
                instructions.querySelector('p').textContent = 'Click "Setup Help" to create target image';
                instructions.style.background = 'rgba(220, 53, 69, 0.9)';
            });
        });
        
        // Target found/lost events
        document.addEventListener('DOMContentLoaded', function() {
            const sceneEl = document.querySelector('a-scene');
            const instructions = document.getElementById('instructions');
            const badges = document.querySelectorAll('.badge');
            const video = document.querySelector('#ar-video');
            
            // Check if targets.mind file exists
            fetch('./assets/targets.mind')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Target file not found');
                    }
                    console.log('‚úÖ Target file loaded successfully');
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è Target file not found. Please create targets.mind file.');
                    instructions.querySelector('h3').textContent = '‚ö†Ô∏è Setup Required';
                    instructions.querySelector('p').textContent = 'Click "Setup Help" button to create AR target';
                    instructions.style.background = 'rgba(255, 193, 7, 0.9)';
                });
            
            // When business card is found
            let scanCount = 0;
            sceneEl.addEventListener('targetFound', event => {
                console.log('‚úÖ Target Found - Showing AR Content');
                scanCount++;
                instructions.classList.add('found');
                instructions.querySelector('h3').textContent = '‚úÖ Business Card Detected!';
                
                if (scanCount === 1) {
                    instructions.querySelector('p').textContent = 'üîá Scan again for sound';
                } else {
                    instructions.querySelector('p').textContent = 'üîä Audio enabled!';
                }
                
                // Video is already handled by play-on-track component
                // Just update UI and show badges
                
                // Show badges with sequential animation
                badges.forEach((badge, index) => {
                    setTimeout(() => {
                        badge.setAttribute('visible', 'true');
                        badge.setAttribute('animation__appear', {
                            property: 'scale',
                            from: '0 0 0',
                            to: '1 1 1',
                            dur: 500,
                            easing: 'easeOutElastic'
                        });
                    }, index * 200); // 200ms delay between each badge
                });
            });
            
            // When business card is lost
            sceneEl.addEventListener('targetLost', event => {
                console.log('‚ùå Target Lost');
                instructions.classList.remove('found');
                instructions.querySelector('h3').textContent = 'üì± Point Camera at Business Card';
                instructions.querySelector('p').textContent = 'Scanning for target image...';
                
                // Video pause is handled by play-on-track component
                
                // Hide badges
                badges.forEach(badge => {
                    badge.setAttribute('visible', 'false');
                });
            });
        });
    </script>
</body>
</html>
